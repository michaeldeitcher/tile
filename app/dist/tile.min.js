/*! tile 03-11-2014 */
window.TileWebGL={Models:{},Controllers:{},Views:{},appController:void 0,appView:void 0,stage:void 0,prefs:{width:30,segmentStartLength:100,depth:10},svgOverlay:void 0,updateTileProject:void 0,activeLayerController:void 0,planes:{},config:{tile:{material:{color:"#ff3131",colorAmbient:"#000000",colorEmissive:"#000000",colorSpecular:"#000000",shininess:30,opacity:1,material:"Lambert"}}}},window.App=window.Overlay=Ember.Application.create(),TileWebGL.Controllers.AppController=function(){function a(){TileWebGL.appController=this,this.initStateMachine(),this.appView=new TileWebGL.Views.AppView,TileWebGL.activeLayerController=this.activeLayerController}return a.prototype.start=function(){return this.stage=new TileWebGL.Models.Stage,this.layerControllers=[new TileWebGL.Controllers.LayerController],this.activeLayerController().start(),this.changeState("show")},a.prototype.activeLayerController=function(){return TileWebGL.appController.layerControllers[0]},a.prototype.zoomIn=function(){return this.appView.adjustCameraPosition([0,0,-200])},a.prototype.zoomOut=function(){return this.appView.adjustCameraPosition([0,0,200])},a.prototype.clearStage=function(){return this.stage.clear(),this.start(),this.enableEditing()},a.prototype.replayHistoryString=function(a){return this.replayHistory(JSON.parse(a))},a.prototype.historyString=function(){return JSON.stringify(this.activeLayerController().layer.history)},a.prototype.enableEditing=function(){return this.changeState("create")},a.prototype.replayHistory=function(a){return this.lastState=this.changeState("replay"),this.activeLayerController().layer.animateHistory(a.reverse())},a.prototype.replayCanvas=function(){var a,b;return this.stage.clear(),a=this.activeLayerController().layer.history,b=this.state,this.start(),this.changeState("replay"),this.lastState=b,this.activeLayerController().layer.animateHistory(a.reverse())},a.prototype.onDoneReplay=function(){return this.changeState(this.lastState)},a.prototype.setMaterial=function(a){var b,c,d,e,f;for(e=this.layerControllers,f=[],c=0,d=e.length;d>c;c++)b=e[c],f.push(b.setMaterial(a));return f},a.prototype.toggleOrbitControls=function(){return this.orbitOn?(TileWebGL.appView.disableOrbitControls(),this.orbitOn=!1):(TileWebGL.appView.enableOrbitControls(),this.orbitOn=!0)},a.prototype.initStateMachine=function(){return this.states=["init","create","replay","show"],this.stateHandlers=[],this.changeState("init")},a.prototype.changeState=function(a){var b,c,d,e,f;if(this.state!==a){if(-1===$.inArray(a,this.states))throw"not a valid state";for(c=this.state,this.state=a,f=this.stateHandlers,d=0,e=f.length;e>d;d++)(b=f[d])(a);return c}},a.prototype.onStateChange=function(a){return this.stateHandlers.push(a)},a}(),TileWebGL.Controllers.LayerController=function(){function a(a,b){this.svg=a,this.stageSize=b}return a.prototype.start=function(){return this.layer=TileWebGL.stage.activeLayer(),this.layerView=new TileWebGL.Views.Layer,this.layer.layerView=this.layerView,this.tileController=new TileWebGL.Controllers.TileController(this.layer),this.tileController.loadTiles(),this.segmentController=new TileWebGL.Controllers.SegmentController,this.controlPointController=new TileWebGL.Controllers.ControlPointController,this.processAction("setVersionInfo",{version:"0.2"}),this.selectedTileSegment=null},a.prototype.setMaterial=function(a){return this.processAction("setMaterial",{material:a})},a.prototype.selectTileSegment=function(a){return this.layer.segment&&this.processAction("clearSelection"),this.processAction("selectTileSegment",{tile:a[0],segment:a[1]})},a.prototype.splitTileSegment=function(a){return this.processAction("splitTileSegment",{tile:a[0],segment:a[1]}),this.selectedControlPoint=null},a.prototype.isTileSelected=function(a){return this.layer.tile?this.layer.tile.id===a[0]:!1},a.prototype.toggleWall=function(){return this.layerView.showWall(null==this.layerView.wall)},a.prototype.mouseUp=function(a){return this.controlPointMoving?this.controlPointMoving=!1:this.layer.segment?this.processAction("clearSelection"):this.processAction("addTile",{coordinates:[a[0],a[1]-.5*TileWebGL.prefs.width]})},a.prototype.mouseMove=function(a){return this.controlPointMoving?(this.processAction("moveControlPoint",{coordinates:a}),this.controlPointMoved=!0):void 0},a.prototype.controlPointMouseDown=function(a){return this.layer.controlPoint&&this.layer.controlPoint.id===a?void 0:(this.processAction("selectControlPoint",{id:a}),this.controlPointMoving=!0,this.controlPointMoved=!1)},a.prototype.controlPointMouseUp=function(a){return this.controlPointMoving?this.controlPointMoving=!1:this.layer.controlPoint&&this.layer.controlPoint.id===a?this.controlPointMoved?this.controlPointMoved=!1:this.processAction("removeControlPoint"):void 0},a.prototype.processAction=function(a,b){return null==b&&(b={}),b.action=a,this.layer.addAction(b),this.layer.processActions()},a}(),TileWebGL.Controllers.TileController=function(){function a(a){this.layer=a}return a.prototype.loadTiles=function(){var a,b,c,d,e;for(d=this.layer.tiles,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(this.addTileView(a.tile,a.location));return e},a.prototype.addTile=function(a){return this.tile?void 0:(this.tile=this.layer.addTile(a),this.addTileView(this.tile,a))},a.prototype.addTileView=function(a,b){var c;return c=this.layer.layerView,c.addTile(a,b),c.enableEditing()},a.prototype.handleMouseUp=function(){return null!=TileWebGL.stage.activeLayer().tile?(TileWebGL.activeLayerController().processAction("clearSelection"),!0):!1},a}(),TileWebGL.Controllers.SegmentController=function(){function a(){}return a.prototype.handleMouseUp=function(a){return"select_end"===TileWebGL.stage.activeLayer().state?(TileWebGL.activeLayerController().processAction("addTileSegment",{coordinates:a}),!0):!1},a}(),TileWebGL.Controllers.ControlPointController=function(){function a(){}return a.prototype.handleMouseMove=function(a){switch(TileWebGL.stage.activeLayer().state){case"select_control_point":case"move_control_point":return TileWebGL.activeLayerController().processAction("moveControlPoint",{coordinates:a})}},a.prototype.handleMouseUp=function(){switch(TileWebGL.stage.activeLayer().state){case"select_control_point":return TileWebGL.activeLayerController().processAction("removeControlPoint");case"move_control_point":return TileWebGL.stage.activeLayer().controlPoint=null,TileWebGL.stage.activeLayer().state="select_all";default:return!1}},a}(),TileWebGL.Controllers.ToolbarController=function(){function a(a){this.svg=a,TileWebGL.toolbarController=this,this.toolbar=new TileWebGL.Views.Toolbar(this),this.addTile=!0,TileWebGL.appController.onStateChange(function(a){return function(b){switch(b){case"replay":return a.toolbar.enableReplay();case"create":return a.toolbar.enableEdit();case"show":return a.toolbar.enableShow()}}}(this))}return a.prototype.flashMessage=function(a){return this.msg=a,this.hud.flashMessage(this.msg)},a.prototype.toolbarOpen=function(){return this.toolbar.opened?(d3.event.stopPropagation(),!0):!1},a.prototype.addPressed=function(){return this.toolbarOpen()?(this.addTile=!0,this.closeToolbar()):void 0},a.prototype.clearPressed=function(){return this.toolbarOpen()?(TileWebGL.appController.clearStage(),this.closeToolbar()):void 0},a.prototype.exitPressed=function(){return this.toolbarOpen()?this.closeToolbar():void 0},a.prototype.replayPressed=function(){return this.toolbarOpen()?(this.closeToolbar(),TileWebGL.appController.replayCanvas()):void 0},a.prototype.continueReplayPressed=function(){return this.toolbarOpen()?(this.closeToolbar(),TileWebGL.stage.activeLayer().continueAnimation()):void 0},a.prototype.completeReplayPressed=function(){return this.toolbarOpen()?(this.closeToolbar(),TileWebGL.stage.activeLayer().completeAnimation()):void 0},a.prototype.savePressed=function(){return this.toolbarOpen()?(this.closeToolbar(),TileWebGL.updateTileProject()):void 0},a.prototype.showToolbar=function(a){return this.toolbar.open(),"create"===TileWebGL.appController.state&&(this.addTile=!0),this.targetCoord=a},a.prototype.closeToolbar=function(){return this.toolbar.close(),this.targetCoord=null,this.addTile=!1},a}(),Overlay.Router.map(function(){return this.resource("planes",{path:"/"}),this.resource("plane",{path:"/plane/:plane_id"}),this.resource("commands"),this.resource("camera")}),Overlay.PlanesRoute=Ember.Route.extend({model:function(){return TileWebGL.Models.Plane.all()}}),Overlay.PlanesController=Ember.ArrayController.extend({start:function(){var a,b;return a=TileWebGL.Models.Plane.getLastPlaneId(),null!=a?this.transitionToRoute("plane",a):(b=TileWebGL.Models.Plane.create(),TileWebGL.Models.Plane.save(),this.transitionToRoute("plane",b.id))}.property(),actions:{createPlane:function(){var a;return a=TileWebGL.Models.Plane.create(),TileWebGL.Models.Plane.save(),this.transitionToRoute("plane",a.id)}}}),Overlay.PlaneRoute=Ember.Route.extend({model:function(a){return TileWebGL.Models.Plane.find(a.plane_id)}}),Overlay.MenuController=Ember.ObjectController.extend({menuToggleText:"Hide menu",menuVisible:!0,actions:{menuToggle:function(){return this.get("menuVisible")?($("ul#menu li:not('#menuToggle')").fadeOut(),this.set("menuVisible",!1),this.set("menuToggleText","Show Menu")):($("ul#menu li:not('#menuToggle')").fadeIn(),this.set("menuVisible",!0),this.set("menuToggleText","Hide Menu"))},goBack:function(){var a;return a=TileWebGL.Models.Plane.getLastPlaneId(),a>-1?this.transitionToRoute("plane",a):void 0}}}),Overlay.PlaneController=Overlay.MenuController.extend({start:function(){var a,b;return this.started||(TileWebGL.appController.start(),TileWebGL.appController.changeState("create"),this.started=!0,b=this.get("model"),a=b.history,a.length>0&&TileWebGL.appController.replayHistoryString(a)),""}.property(),actions:{save:function(){var a;return a=this.get("model"),a.history=TileWebGL.appController.historyString(),TileWebGL.Models.Plane.save()},replay:function(){return TileWebGL.appController.replayCanvas()},clear:function(){return TileWebGL.appController.clearStage()},menuSelectShow:function(){return this.selectMenuShown?(this.selectMenuShown=!1,$("#menuPlane").fadeIn("fast"),$('.menu:not("#menuPlane")').fadeOut("slow")):(this.selectMenuShown=!0,$("#menuSelect").fadeIn("fast"))},menuCameraShow:function(){return $("#menuCamera").fadeIn("fast"),$('.menu:not("#menuCamera")').fadeOut("slow"),this.selectMenuShown=!1},zoomIn:function(){return TileWebGL.appController.zoomIn()},zoomOut:function(){return TileWebGL.appController.zoomOut()},menuColorsShow:function(){return $("#menuColors").fadeIn("fast"),$('.menu:not("#menuColors")').fadeOut("slow"),this.selectMenuShown=!1},red:function(){return this["private"].updateColor("#FF0000")},blue:function(){return this["private"].updateColor("#0000FF")},white:function(){return this["private"].updateColor("#999999")},menuConfigShow:function(){return $("#menuConfig").fadeIn("fast"),$('.menu:not("#menuConfig")').fadeOut("slow"),this.selectMenuShown=!1},tileDepthIncrease:function(){return window.TileWebGL.depth+=5},tileDepthDecrease:function(){return window.TileWebGL.depth<5?void 0:window.TileWebGL.depth-=5}},"private":{updateColor:function(a){var b,c;return b=TileWebGL.activeLayerController().layer,c=$.extend({},b.material),c.color=a,TileWebGL.activeLayerController().processAction("setMaterial",{material:c})}}}),Overlay.CommandsController=Overlay.MenuController.extend({actions:{startRecording:function(){return TileWebGL.Models.Macro.startRecordingMacro()},play:function(){var a,b;return TileWebGL.Models.MacroReplay.stop=!1,b=TileWebGL.Models.Macro.recordingMacro(),a={macro_id:b.id},TileWebGL.activeLayerController().layer.playMacro(a)},stop:function(){return TileWebGL.Models.MacroReplay.stop=!0}}}),TileWebGL.Models.Config=function(){function a(){}return a}(),TileWebGL.Models.Layer=function(){function a(a){this.stage=a,this.startTime=(new Date).getTime(),this.history=[],this.tiles=[],this.actions=[],this.tile=null,this.segment=null,this.controlPoint=null,this.material=TileWebGL.config.tile.material}return a.prototype.clear=function(){return this.layerView.clear(),this.tiles=[],this.tile=null,this.segment=null,this.controlPoint=null},a.prototype.addAction=function(a){var b;return this.controlPoint&&"moveControlPoint"===a.action&&(b=addPoint(this.controlPoint.coord(),this.tile.location),a.location_delta=subtractPoint(b,a.coordinates)),this.actions.push(a)},a.prototype.processActions=function(){var a,b,c;for(c=[];this.actions.length>0;)a=this.actions.pop(),b=TileWebGL.Models.Macro.recordingMacro(),b&&b.recordAction(a),c.push(this.processAction(a));return c},a.prototype.processAction=function(a,b){var c,d;switch(null==b&&(b=null),"moveControlPoint"!==a.action&&console.log(a),"0.01"===this.version&&(d=a.coordinates,d&&(a.coordinates=[d[0]-250,250-d[1]])),a.action){case"addTile":this.addTile(a);break;case"addTileSegment":this.addTileSegment(a);break;case"selectTileSegment":this.selectTileSegment(a);break;case"splitTileSegment":this.splitTileSegment(a);break;case"selectControlPoint":this.selectControlPoint(a);break;case"clearSelection":this.clearSelection(a);break;case"moveControlPoint":this.moveControlPoint(a);break;case"removeControlPoint":this.removeControlPoint(a);break;case"setMaterial":this.setMaterial(a);break;case"setVersionInfo":this.setVersion(a);break;case"playMacro":this.playMacro(a);break;case"startMacro":this.startMacro(a);break;case"macroAddTileSegment":this.macroAddTileSegment(a);break;default:throw"unsupported action"}return null==b&&(c=(new Date).getTime(),b=null!=this.lastTime?c-this.lastTime:0),this.history.push([a,b]),this.lastTime=c},a.prototype.animateHistory=function(a){var b;return this.replay=a,b=function(a){return function(){var c;if(!a.paused)return a.processAction(a.history_item[0]),a.history_item=a.replay.pop(),null!=a.history_item?(c=a.history_item[1]>250?250:a.history_item[1],setTimeout(b,c)):TileWebGL.appController.onDoneReplay()}}(this),this.history_item=this.replay.pop(),b()},a.prototype.pauseAnimation=function(){return this.paused=!0},a.prototype.continueAnimation=function(){return this.paused=!1,this.animateHistory(this.replay)},a.prototype.completeAnimation=function(){for(;this.replay.length>0;)this.processAction(this.replay.pop()[0]);return this.clearSelection(),TileWebGL.appController.onDoneReplay()},a.prototype.addTile=function(a){return this.tile=new TileWebGL.Models.Tile(this.tiles.length,a.coordinates),this.tile.setMaterial(this.material),this.tiles.push(this.tile),this.segment=this.tile.getSegment(0),this.layerView.redrawTile(this.tile,!0)},a.prototype.addTileSegment=function(a){var b;return b=this.tile.addTileSegment(subtractPoint(a.coordinates,this.tile.location)),this.layerView.redrawTile(this.tile),this.selectTileSegment({tile:this.tile.id,segment:b.id})},a.prototype.selectTileSegment=function(a,b){var c;return this.state=null!=b?b:"select_all",this.tile=this.tiles[a.tile],c=this.tile.getSegment(a.segment),this.segment=c},a.prototype.isSegmentSelected=function(a,b){return this.tile&&this.tile.id===a&&this.segment&&this.segment.id===b},a.prototype.splitTileSegment=function(a){return this.tile=this.tiles[a.tile],this.segment=this.tile.getSegment(a.segment),this.segment.split(),this.controlPoint=null,this.layerView.redrawTile(this.tile)},a.prototype.selectControlPoint=function(a){return this.controlPoint=this.tile.getControlPoint(a.id),this.state="select_control_point"},a.prototype.clearSelection=function(){return this.layerView.clearSelection(),this.tile=null,this.segment=null,this.controlPoint=null,this.state="none"},a.prototype.moveControlPoint=function(a){return null!=a.location_delta?this.controlPoint.moveDelta(a.location_delta):this.controlPoint.move(subtractPoint(a.coordinates,this.tile.location)),this.layerView.redrawTile(this.tile),this.state="move_control_point"},a.prototype.removeControlPoint=function(){return this.controlPoint.remove(),this.layerView.redrawTile(this.tile,!0)},a.prototype.setVersion=function(a){return this.version=a.version},a.prototype.playMacro=function(a){return this.replayMacro=new TileWebGL.Models.MacroReplay(a,this).play()},a.prototype.stopMacro=function(){return this.replayMacro.stop()},a.prototype.macroAddTileSegment=function(){var a;return a=this.tile.addTileSegment(),this.layerView.redrawTile(this.tile),this.selectTileSegment({tile:this.tile.id,segment:a.id})},a.prototype.setMaterial=function(a){return this.material=Object.create(a.material),this.tile?(this.tile.setMaterial(this.material),this.layerView.redrawTile(this.tile)):void 0},a}(),TileWebGL.Models.Macro=function(){function a(){this.id=this.constructor._numMacros,this.constructor._macros[this.id]=this,this.constructor._numMacros++,this._actionRecording=[]}return a._numMacros=0,a._macros={},a.find=function(a){return this._macros[a]},a.recordingMacro=function(){return this._recordingMacro},a.startRecordingMacro=function(){return this._recordingMacro=new TileWebGL.Models.Macro},a.prototype.recordAction=function(a){var b,c;if(-1!==["addTile","selectTileSegment","splitTileSegment","selectControlPoint","clearSelection","moveControlPoint","removeControlPoint"].indexOf(a.action))return c=(new Date).getTime(),b=null!=this.lastTime?c-this.lastTime:0,this._actionRecording.push([a,b])},a.prototype.actions=function(){return this._actionRecording.slice().reverse()},a}(),TileWebGL.Models.MacroReplay=function(){function a(a,b){if(this.d=a,this.layer=b,this.macro=TileWebGL.Models.Macro.find(a.macro_id),null==this.macro)throw"could not find macro";this.controlPoint=this.layer.controlPoint,this.controlPoint&&(this.controlPointOffset=this.controlPoint.id),this.tileSegmentOffset=this.layer.tile.numOfSegments()}return a.stop=!1,a.prototype.play=function(){var a;return this.macroActions=this.macro.actions(),a=function(b){return function(){var c;if(!TileWebGL.Models.MacroReplay.stop)return b.layer.processAction(b.transposeAction(b.macroAction[0])),b.macroAction=b.macroActions.pop(),null!=b.macroAction?(c=b.macroAction[1]>250?250:b.macroAction[1],setTimeout(a,c)):void 0}}(this),this.macroAction=this.macroActions.pop(),a()},a.prototype.transposeAction=function(a){var b;return b=$.extend({},a),"selectTileSegment"===b.action&&null!=this.tileSegmentOffset&&(b.segment+=this.tileSegmentOffset),"selectControlPoint"===b.action&&null!=this.controlPointOffset&&(b.id+=this.controlPointOffset),"addTile"===b.action&&(b.action="macroAddTileSegment"),b},a.prototype.stop=function(){return TileWebGL.Models.MacroReplay.stop=!0},a}(),TileWebGL.Models.Stage=function(){function a(){TileWebGL.stage=this,this.layers=[],this.macros=[],this.layers[0]=new TileWebGL.Models.Layer(this)}return a.prototype.clear=function(){var a,b,c,d,e;for(d=this.layers,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.clear());return e},a.prototype.activeLayer=function(){return this.layers[0]},a.setCameraPosition=function(a){return localStorage.setItem("camera",JSON.stringify(a))},a.getCameraPosition=function(){var a;return a=localStorage.getItem("camera"),a?JSON.parse(a):[0,0,3e3]},a}(),TileWebGL.Models.Plane=function(){function a(){this.id=this.constructor._numPlanes,this.version="v0.2",this.date=new Date,this.title="P"+this.id,this.history="",this.constructor._planes[this.id]=this,this.constructor._numPlanes++}var b,c;return c=localStorage.getItem("planes"),c?(b=JSON.parse(c),a._planes=b.planes,a._numPlanes=b.numPlanes):(a._numPlanes=0,a._planes=[]),a.find=function(a){return b=this._planes[a],null!=b&&this.setLastPlaneId(a),b},a.create=function(){return this.setLastPlaneId(this._planes.length),new TileWebGL.Models.Plane},a.all=function(){var a,b,d,e;for(c=[],e=this._planes,b=0,d=e.length;d>b;b++)a=e[b],c.push(a);return c},a.save=function(){return localStorage.setItem("planes",JSON.stringify({numPlanes:this._numPlanes,planes:this._planes}))},a.getLastPlaneId=function(){var a;return a=localStorage.getItem("lastPlaneId"),a?JSON.parse(a):void 0},a.setLastPlaneId=function(a){return localStorage.setItem("lastPlaneId",JSON.stringify(a))},a}(),TileWebGL.Models.Config=function(){function a(){}return a.prototype.contructor=function(){return this.materials={}},a.prototype.load=function(){var a,b,c,d;b=JSON.parse(localStorage.getItem("materials")),d=[];for(a in b)c=b[a],d.push(this.materials[a]=(new TileWebGL.Models.Material).load(c));return d},a.prototype.save=function(){var a,b,c,d;a={},d=this.materials;for(b in d)c=d[b],a[b]=c.data;return localStorage.setItem("car",JSON.stringify(a))},a}(),TileWebGL.Models.Material=function(){function a(){this.data={color:16777215,ambient:16777215,colorEmissive:16777215,specular:16777215,shininess:30,opacity:1,transparent:!1}}return a.prototype.load=function(a){return null==a&&(a={}),$.extend(this.data,a)},a}();var pad;pad=function(a,b,c){return c=c||"0",a+="",a.length>=b?a:new Array(b-a.length+1).join(c)+a},TileWebGL.Models.ControlPoint=function(){function a(a,b){var c;this.tile=a,this.id=b,this.segment=this.tile.getSegment(0===this.id?0:this.id-1),c=this.id<2?0:this.id-1}return a.prototype.coord=function(){var a;return a=this.isStart()?midPoint(this.segment.data[0],this.segment.data[3]):midPoint(this.segment.data[1],this.segment.data[2]),[Math.ceil(a[0]),Math.ceil(a[1])]},a.prototype.isStart=function(){return 0===this.id},a.prototype.isEnd=function(){return!this.isStart()},a.prototype.moveDelta=function(a){return this.move(subtractPoint(this.coord(),a))},a.prototype.move=function(a){return this.isStart()?this.tile.moveStart(this.segment,a):(this.tile.moveEnd(this.segment,a),this.tile.startEndConnected&&this.segment.isEnd()&&this.tile.moveStart(this.tile.getSegment(0),a)),this.tile.resolveStartEnd()},a.prototype.remove=function(){return this.isStart()?this.segment.mergeLast():this.segment.mergeNext()},a}(),TileWebGL.Models.Segment=function(){function a(a,b){var c,d;this.tile=a,this.id=b,this.tile.data.length>this.id?(this.data=this.tile.data[this.id],this.lastData=this.tile.data[this.id-1]):(d=TileWebGL.prefs.width,c=TileWebGL.prefs.segmentStartLength,this.data=[[0,0],[c,0],[c,d],[0,d]])}return a.prototype.controlPointData=function(a){var b;return null==a&&(a=!0),b=[],0===this.id&&a&&b.push({coord:midPoint(this.data[0],this.data[3]),id:0}),b.push({coord:midPoint(this.data[1],this.data[2]),id:this.id+1}),b},a.prototype.split=function(){var a;return a=[midPoint(this.data[0],this.data[1]),this.data[1],this.data[2],midPoint(this.data[2],this.data[3])],this.tile.data[this.id][1]=a[0],this.tile.data[this.id][2]=a[3],this.tile.insertSegment(this.id+1,a)},a.prototype.mergeLast=function(){var a;return a=midPoint(this.data[1],this.data[2]),this.tile.data.splice(this.id,1),this.tile.data.length>0?this.tile.moveEnd(new TileWebGL.Models.Segment(this.tile,this.id),a):void 0},a.prototype.mergeNext=function(){var a;return a=midPoint(this.data[0],this.data[3]),this.tile.data.splice(this.id,1),this.id<this.tile.data.length?this.tile.moveStart(new TileWebGL.Models.Segment(this.tile,this.id),a):void 0},a.prototype.getLast=function(){return this.id-1>=0?new TileWebGL.Models.Segment(this.tile,this.id-1):null},a.prototype.getNext=function(){return this.id+1<this.tile.data.length?new TileWebGL.Models.Segment(this.tile,this.id+1):null},a.prototype.isEnd=function(){return null==this.getNext()},a}(),TileWebGL.Models.Tile=function(){function a(a,b){var c,d;this.id=a,this.location=b,d=TileWebGL.prefs.width,c=TileWebGL.prefs.segmentStartLength,this.data=[[[0,0],[c,0],[c,d],[0,d]]]}return a.prototype.setMaterial=function(a){return this.material={material:a.material,color:parseInt(a.color.replace("#","0x")),colorAmbient:parseInt(a.colorAmbient.replace("#","0x")),colorEmissive:parseInt(a.colorEmissive.replace("#","0x")),colorSpecular:parseInt(a.colorSpecular.replace("#","0x")),shininess:a.shininess,opacity:a.opacity,transparent:!0}},a.prototype.getMaterial=function(){return{material:this.material.material,color:"#"+pad(this.material.color.toString(16),6),colorAmbient:"#"+pad(this.material.colorAmbient.toString(16),6),colorEmissive:"#"+pad(this.material.colorEmissive.toString(16),6),colorSpecular:"#"+pad(this.material.colorSpecular.toString(16),6),shininess:this.material.shininess,opacity:this.material.opacity,transparent:!0}},a.prototype.numOfSegments=function(){return this.data.length},a.prototype.getSegment=function(a){return new TileWebGL.Models.Segment(this,a)},a.prototype.addSegment=function(){var a;return a=new TileWebGL.Models.Segment(this,this.data.length-1),this.data[this.data.length]=[a.data[1],addPoint(a.data[1],[TileWebGL.prefs.segmentStartLength,0]),addPoint(a.data[2],[TileWebGL.prefs.segmentStartLength,0]),a.data[2]]},a.prototype.getControlPoint=function(a){return new TileWebGL.Models.ControlPoint(this,a)},a.prototype.controlPointData=function(){var a,b,c,d,e,f;if(c=this.numOfSegments(),a=[],1>c)return a;for(b=e=0,f=c-1;f>=0?f>=e:e>=f;b=f>=0?++e:--e)d=this.getSegment(b),a=a.concat(d.controlPointData());return a},a.prototype.addTileSegment=function(a){var b;return null==a&&(a=null),this.addSegment(),b=new TileWebGL.Models.Segment(this,this.data.length-1),a&&this.moveEnd(b,a),b},a.prototype.insertSegment=function(a,b){var c,d,e;for(c=this.data.length,this.data[c]=[],d=e=c;a>=c?a>=e:e>=a;d=a>=c?++e:--e)this.data[d]=this.data[d-1];return this.data[a]=b},a.prototype.moveEnd=function(a,b){var c,d,e,f,g,h;return a.id>0?(e=new TileWebGL.Models.Segment(this,a.id-1),f=getVector({start:midPoint(e.data[1],e.data[2]),end:midPoint(e.data[1],e.data[2])}),d=midPoint(e.data[1],e.data[2])):d=midPoint(a.data[0],a.data[3]),h=getVector({start:d,end:b}),0!==h.direction?(this.movePoints(a,h,b),g=a.getNext(),null!=g?this.moveStart(g,b):(c=this.getControlPoint(0).coord(),getDistance(b,c)<2?(this.startEndConnected=!0,this.resolveStartEnd()):void 0)):void 0},a.prototype.moveStart=function(a,b){var c,d;return c=midPoint(a.data[1],a.data[2]),d=getVector({start:b,end:c}),0!==d.direction?this.movePoints(a,d,c):void 0},a.prototype.movePoints=function(a,b,c){var d,e,f,g,h,i,j,k,l,m;return d=new TileWebGL.Models.Segment(this,a.id-1),j=getOrthogonalVector(b),e=movePoint(c,getVector({direction:j.direction,magnitude:TileWebGL.prefs.width/-2})),l=movePoint(c,getVector({direction:j.direction,magnitude:TileWebGL.prefs.width/2})),k=getVector({direction:b.direction,magnitude:-b.magnitude}),f=movePoint(e,k),m=movePoint(l,k),a.id>0&&(g=[d.data[0],d.data[1]],h=[f,e],f=getPointIntersected(g,h),g=[d.data[3],d.data[2]],h=[m,l],m=getPointIntersected(g,h),this.data[a.id-1][1]=f,this.data[a.id-1][2]=m),this.data.length>a.id+1&&(i=new TileWebGL.Models.Segment(this,a.id+1),g=[i.data[0],i.data[1]],h=[f,e],e=getPointIntersected(g,h),g=[i.data[3],i.data[2]],h=[m,l],l=getPointIntersected(g,h),this.data[a.id+1][0]=e,this.data[a.id+1][3]=l),this.data[a.id]=[f,e,l,m]},a.prototype.resolveStartEnd=function(){var a,b,c,d,e,f;if(this.startEndConnected)return a=this.getSegment(0),b=this.getSegment(this.numOfSegments()-1),d=[b.data[0],b.data[1]],e=[a.data[0],a.data[1]],c=getPointIntersected(d,e),d=[b.data[3],b.data[2]],e=[a.data[3],a.data[2]],f=getPointIntersected(d,e),this.data[0][0]=this.data[b.id][1]=c,this.data[0][3]=this.data[b.id][2]=f},a}(),window.Geometry={},Geometry.transformPoint=function(a,b){var c;return c=[],c[0]=a[0]*b[0][0]+a[1]*b[0][1],c[1]=a[0]*b[1][0]+a[1]*b[1][1],c},Geometry.subtractPoint=function(a,b){return[a[0]-b[0],a[1]-b[1]]},Geometry.addPoint=function(a,b){return[a[0]+b[0],a[1]+b[1]]},Geometry.midPoint=function(a,b){return[(a[0]+b[0])/2,(a[1]+b[1])/2]},Geometry.getDistance=function(a,b){return Math.sqrt(Math.pow(b[1]-a[1],2)+Math.pow(b[0]-a[0],2))},Geometry.getDirection=function(a,b){return Math.atan2(b[1]-a[1],b[0]-a[0])},Geometry.getVector=function(a){var b,c;if(null!=a.start&&null!=a.end)c=Geometry.getDistance(a.start,a.end),b=Geometry.getDirection(a.start,a.end);else{if(null==a.direction||null==a.magnitude)throw"missing required arguments";c=a.magnitude,b=a.direction}return{magnitude:c,direction:b}},Geometry.getOrthogonalVector=function(a){return{magnitude:a.magnitude,direction:a.direction+Math.PI/2}},Geometry.movePoint=function(a,b){var c,d,e;return e=b.direction,c=[[Math.cos(e),-Math.sin(e)],[Math.sin(e),Math.cos(e)]],d=Geometry.transformPoint([b.magnitude,0],c),Geometry.addPoint(a,d)},Geometry.getPointIntersected=function(a,b){var c;return c=Geometry.checkLineIntersection(a[0][0],a[0][1],a[1][0],a[1][1],b[0][0],b[0][1],b[1][0],b[1][1]),[c.x,c.y]},Geometry.checkLineIntersection=function(a,b,c,d,e,f,g,h){var i,j,k,l,m,n;return k=void 0,i=void 0,j=void 0,l=void 0,m=void 0,n={x:null,y:null,onLine1:!1,onLine2:!1},k=(h-f)*(c-a)-(g-e)*(d-b),0===k?n:(i=b-f,j=a-e,l=(g-e)*i-(h-f)*j,m=(c-a)*i-(d-b)*j,i=l/k,j=m/k,n.x=a+i*(c-a),n.y=b+i*(d-b),i>0&&1>i&&(n.onLine1=!0),j>0&&1>j&&(n.onLine2=!0),n)},TileWebGL.Views.AppView=function(){function a(){TileWebGL.appView=this,this.domContainer=document.getElementById("ThreeJS"),this.objects=[],this.createScene(),this.addLights(),this.registerEvents(),this.animate()}return a.prototype.createScene=function(){return this.scene=new THREE.Scene,this.width=window.innerWidth,this.height=window.innerHeight,this.aspect=this.width/this.height,this.near=.1,this.far=2e4,this.camera=new THREE.PerspectiveCamera(10,this.aspect,this.near,this.far),this.updateCameraPosition(),this.projector=new THREE.Projector,this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.setSize(this.width,this.height),this.domContainer.appendChild(this.renderer.domElement)},a.prototype.animate=function(){return requestAnimationFrame(TileWebGL.appView.animate),TileWebGL.appView.render(),TileWebGL.appView.update()},a.prototype.render=function(){return this.renderer.render(this.scene,this.camera)},a.prototype.update=function(){return null!=this.controls&&this.controls.update(),null!=this.stats?this.stats.update():void 0},a.prototype.updateCameraPosition=function(){var a;return null==this.cameraPosition&&(this.cameraPosition=TileWebGL.Models.Stage.getCameraPosition()),a=this.cameraPosition,this.camera.position.set(a[0],a[1],a[2]),this.camera.lookAt(this.scene.position)},a.prototype.adjustCameraPosition=function(a){return this.cameraPosition[0]+=a[0],this.cameraPosition[1]+=a[1],this.cameraPosition[2]+=a[2],this.updateCameraPosition(),TileWebGL.Models.Stage.setCameraPosition(this.cameraPosition)},a.prototype.addLights=function(){var a;return a=new THREE.PointLight(16777215),a.position.set(200,200,150),this.scene.add(a),a=new THREE.PointLight(16777215),a.position.set(0,0,300),this.scene.add(a)},a.prototype.toggleStats=function(){return this.stats?this.domContainer.removeChild(this.stats.domElement):(this.stats=new Stats,this.stats.domElement.style.position="absolute",this.stats.domElement.style.bottom="0px",this.stats.domElement.style.zIndex=100,this.domContainer.appendChild(this.stats.domElement))},a.prototype.addToScene=function(a){return this.scene.add(a),this.objects.push(a)},a.prototype.removeFromScene=function(a){var b;return this.scene.remove(a),b=this.objects.indexOf(a),b>-1?this.objects.splice(b,1):void 0},a.prototype.registerEvents=function(){var a;return THREEx.WindowResize(this.renderer,this.camera),THREEx.FullScreen.bindKey({charCode:"m".charCodeAt(0)}),this.touches={},a=this.renderer.domElement,Modernizr.touch?(a.addEventListener("touchstart",function(a){return function(b){var c,d,e,f,g;for(f=b.changedTouches,g=[],d=0,e=f.length;e>d;d++)c=f[d],g.push(a.touchStart(c));return g}}(this)),a.addEventListener("touchend",function(a){return function(b){var c,d,e,f,g;for(f=b.changedTouches,g=[],d=0,e=f.length;e>d;d++)c=f[d],g.push(a.touchEnd(c));return g}}(this)),a.addEventListener("touchcancel",function(a){return function(b){var c,d,e,f,g;for(f=b.changedTouches,g=[],d=0,e=f.length;e>d;d++)c=f[d],g.push(a.touchCancel(c));return g}}(this)),a.addEventListener("touchmove",function(a){return function(b){var c,d,e,f,g;for(f=b.changedTouches,g=[],d=0,e=f.length;e>d;d++)c=f[d],g.push(a.touchMove(c));return g}}(this))):(a.addEventListener("mousemove",function(a){return function(b){return a.handleMoveEvent([b.clientX,b.clientY])}}(this)),a.addEventListener("mouseup",function(a){return function(b){return a.handleUpEvent([b.clientX,b.clientY])
}}(this)),a.addEventListener("mousedown",function(a){return function(b){return a.handleDownEvent([b.clientX,b.clientY])}}(this)))},a.prototype.copyTouch=function(a){return{identifier:a.identifier,pageX:a.pageX,pageY:a.pageY}},a.prototype.touchStart=function(a){return this.touches[a.identifier]=a,this.handleDownEvent([a.pageX,a.pageY])},a.prototype.touchMove=function(a){return this.handleMoveEvent([a.pageX,a.pageY])},a.prototype.touchEnd=function(a){return this.handleUpEvent([a.pageX,a.pageY])},a.prototype.handleMoveEvent=function(a){var b,c;return b=this.raycastIntersects(a),null==b||b.object.view.mouseMove([b.point.x,b.point.y])?void 0:(c=TileWebGL.appController.activeLayerController(),c.mouseMove([b.point.x,b.point.y]))},a.prototype.handleUpEvent=function(a){var b,c;if(!this.ignoreMouseEvents)return b=this.raycastIntersects(a),null==b||b.object.view.mouseUp([b.point.x,b.point.y])?void 0:(c=TileWebGL.appController.activeLayerController(),c.mouseUp([b.point.x,b.point.y]))},a.prototype.handleDownEvent=function(a){var b;return b=this.raycastIntersects(a),null!=b?b.object.view.mouseDown([b.point.x,b.point.y]):void 0},a.prototype.raycastIntersects=function(a){var b,c,d,e,f;return c=a[0]/window.innerWidth*2-1,d=2*-(a[1]/window.innerHeight)+1,b=new THREE.Vector3(c,d,1),this.projector.unprojectVector(b,this.camera),f=new THREE.Raycaster(this.camera.position,b.sub(this.camera.position).normalize()),e=f.intersectObjects(this.objects),e?e[0]:void 0},a}(),TileWebGL.Views.Layer=function(){function a(){this.stage=TileWebGL.appView.stage,TileWebGL.layerView=this,this.tileViews={},this.controller=TileWebGL.appController.activeLayerController(),TileWebGL.appController.onStateChange(function(a){return function(b){switch(b){case"create":return a.showWall();default:return a.showWall(!1)}}}(this))}return a.prototype.redrawTile=function(a,b){var c;return null==b&&(b=!1),c=this.tileViews[a.id],c||(c=new TileWebGL.Views.Tile(this,a),this.tileViews[a.id]=c),b&&(c.tileSelected=!0),c.redraw()},a.prototype.clearSelection=function(){var a;return TileWebGL.stage.activeLayer().tile&&(a=this.tileViews[TileWebGL.stage.activeLayer().tile.id]),a?a.selectTile(!1):void 0},a.prototype.clear=function(){var a,b,c,d;c=this.tileViews,d=[];for(a in c)b=c[a],d.push(b.destroy());return d},a.prototype.showWall=function(a){return null==a&&(a=!0),a?this.wall=(new TileWebGL.Views.Wall).create():this.wall?(this.wall.destroy(),this.wall=null):void 0},a}(),TileWebGL.Views.Wall=function(){function a(){this.appView=TileWebGL.appView,this.layerController=TileWebGL.activeLayerController()}return a.prototype.create=function(){var a,b;return b=new THREE.MeshBasicMaterial({color:0}),a=new THREE.PlaneGeometry(6e3,6e3,1),this.wall=new THREE.Mesh(a,b),this.wall.position.set(0,0,1),this.wall.view=this,this.appView.addToScene(this.wall),this},a.prototype.destroy=function(){return this.appView.removeFromScene(this.wall)},a.prototype.mouseMove=function(){return!1},a.prototype.mouseDown=function(){return!1},a.prototype.mouseUp=function(){return!1},a}(),TileWebGL.Views.Overlay=function(){function a(){this.currentPanel=null,new TileWebGL.Views.GUI}return a.prototype.showPanel=function(a){this.panelName=a},a.prototype.hidePanel=function(){return this.currentPanel.visible?this.currentPanel.hide():void 0},a}(),TileWebGL.Views.GUI=function(){function a(){}return a}();var ThreeView;ThreeView=function(){function a(){}return a.prototype.getCoordinates=function(a){var b,c,d,e,f;return d=a.clientX/window.innerWidth*2-1,e=2*-(a.clientY/window.innerHeight)+1,c=new THREE.Vector3(d,e,1),this.projector.unprojectVector(c,this.camera),f=new THREE.Raycaster(this.camera.position,c.sub(this.camera.position).normalize()),b=f.intersectObjects(this.objects),b.length>0?[b[0].point.x,b[0].point.y]:null},a}(),TileWebGL.Views.Tile=function(){function a(a,b){this.layerView=a,this.tile=b,this.segments=[],this.controlPoints=[],this.tileSelected=!1,this.redraw()}return a.prototype.redraw=function(){return this.redrawSegments(),this.redrawControlPoints()},a.prototype.redrawSegments=function(){var a,b,c,d,e,f;for(e=this.segments,c=0,d=e.length;d>c;c++)b=e[c],b.destroy();for(this.segments=[],a=0,f=[];a<this.tile.data.length;)this.segments.push(new TileWebGL.Views.TileSegment(this,a).create()),f.push(a++);return f},a.prototype.redrawControlPoints=function(){var a,b,c,d,e,f,g;for(f=this.controlPoints,d=0,e=f.length;e>d;d++)a=f[d],a.destroy();if(this.controlPoints=[],this.tileSelected){for(c=0,b=this.tile.controlPointData(),g=[];c<b.length;)this.controlPoints.push(new TileWebGL.Views.ControlPoint(this,b[c].coord,c).create()),g.push(c++);return g}},a.prototype.selectTile=function(a){return null==a&&(a=!0),this.tileSelected=a,this.redrawControlPoints()},a.prototype.destroy=function(){var a,b,c,d,e,f,g,h,i;for(g=this.segments,c=0,e=g.length;e>c;c++)b=g[c],b.destroy();for(h=this.controlPoints,i=[],d=0,f=h.length;f>d;d++)a=h[d],i.push(a.destroy());return i},a.prototype.tilePosZ=function(){return 5*this.tile.id},a}(),TileWebGL.Views.TileSegment=function(){function a(a,b){this.tileView=a,this.segmentIndex=b,this.appView=TileWebGL.appView,this.layerController=TileWebGL.activeLayerController(),this.tile=this.tileView.tile,this.data=this.tile.data[this.segmentIndex]}return a.prototype.create=function(a){var b;return b=function(){switch(this.tile.material.material){case"Basic":return new THREE.MeshBasicMaterial(this.tile.material);case"Lambert":return new THREE.MeshLambertMaterial(this.tile.material);case"Phong":return new THREE.MeshPhongMaterial(this.tile.material);case"Wireframe":return $.extend(a,{wireframe:!0},this.tile.material),new THREE.MeshBasicMaterial(a)}}.call(this),b.side=THREE.DoubleSide,this.segment=new THREE.Mesh(this.geometry(),b),this.segment.view=this,this.appView.addToScene(this.segment),this},a.prototype.destroy=function(){return this.appView.removeFromScene(this.segment)},a.prototype.mouseMove=function(){return!1},a.prototype.mouseDown=function(){return this.state="mousedown",!0},a.prototype.mouseUp=function(){var a;if("mousedown"===this.state)return a=[this.tile.id,this.segmentIndex],this.layerController.isTileSelected(a)?this.layerController.splitTileSegment(a):(this.layerController.selectTileSegment(a),this.tileView.selectTile()),this.state=void 0,!0},a.prototype.tilePosZ=function(){return this.tileView.tilePosZ()},a.prototype.geometry=function(){var a,b;for(a=new THREE.Geometry,b=0;b<this.data.length;)a.vertices.push(this.vector3(b,TileWebGL.prefs.depth+this.tilePosZ())),a.vertices.push(this.vector3(b,this.tilePosZ())),b++;return a.faces.push(new THREE.Face3(0,2,4)),a.faces.push(new THREE.Face3(0,6,4)),a.faces.push(new THREE.Face3(1,3,5)),a.faces.push(new THREE.Face3(1,7,5)),a.faces.push(new THREE.Face3(7,6,4)),a.faces.push(new THREE.Face3(5,7,4)),a.faces.push(new THREE.Face3(3,2,0)),a.faces.push(new THREE.Face3(1,3,0)),a.faces.push(new THREE.Face3(1,0,6)),a.faces.push(new THREE.Face3(7,1,6)),a.faces.push(new THREE.Face3(5,4,2)),a.faces.push(new THREE.Face3(3,5,2)),a.computeFaceNormals(),a},a.prototype.vector3=function(a,b){var c,d;return d=this.data[a],c=this.tile.location,new THREE.Vector3(d[0]+c[0],d[1]+c[1],b)},a}(),TileWebGL.Views.ControlPoint=function(){function a(a,b,c){this.tileView=a,this.coord=b,this.id=c,this.appView=TileWebGL.appView,this.layerController=TileWebGL.activeLayerController(),this.layer=this.layerController.layer,this.tile=this.tileView.tile}return a.prototype.createInnerCircle=function(){var a,b,c;return b=new THREE.MeshLambertMaterial({emissive:2105376}),a=new THREE.RingGeometry(8,14,32),c=this.tile.location,this.innerCircle=new THREE.Mesh(a,b),this.innerCircle.position.x=this.coord[0]+c[0],this.innerCircle.position.y=this.coord[1]+c[1],this.innerCircle.position.z=TileWebGL.prefs.depth+this.tileView.tilePosZ()+10,this.innerCircle.view=this,this.appView.addToScene(this.innerCircle)},a.prototype.createOuterCircle=function(){var a,b,c;return b=new THREE.MeshBasicMaterial({transparent:!0,opacity:0}),a=new THREE.CircleGeometry(20,32),c=this.tile.location,this.outerCircle=new THREE.Mesh(a,b),this.outerCircle.position.x=this.coord[0]+c[0],this.outerCircle.position.y=this.coord[1]+c[1],this.outerCircle.position.z=TileWebGL.prefs.depth+this.tileView.tilePosZ()+1,this.outerCircle.view=this,this.appView.addToScene(this.outerCircle)},a.prototype.create=function(){return this.createInnerCircle(),this.createOuterCircle(),this},a.prototype.destroy=function(){return this.appView.removeFromScene(this.innerCircle),this.appView.removeFromScene(this.outerCircle)},a.prototype.mouseMove=function(){return!1},a.prototype.mouseDown=function(){return this.layerController.controlPointMouseDown(this.id),!0},a.prototype.mouseUp=function(){return this.layerController.controlPointMouseUp(this.id),!0},a.prototype.vector3=function(a,b){var c,d;return d=this.data[a],c=this.tile.location,new THREE.Vector3(d[0]+c[0],d[1]+c[1],b)},a}();var property;for(property in Geometry)window[property]=Geometry[property];new TileWebGL.Controllers.AppController,document.ontouchmove=function(a){return a.preventDefault()};